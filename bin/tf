#!/usr/bin/env python3
import os
import shutil
import subprocess
import sys
from pathlib import Path
from typing import Dict, List, Optional

DEFAULT_UVX_SOURCE = "git+https://github.com/legout/pi-ticketflow"


def read_root_file(path: Path) -> str:
    try:
        return path.read_text(encoding="utf-8").strip()
    except Exception:
        return ""


def find_repo_root() -> Optional[Path]:
    env_root = os.environ.get("TF_REPO_ROOT", "").strip()
    if env_root:
        path = Path(env_root).expanduser()
        if path.exists():
            return path

    cwd = Path.cwd()
    for parent in [cwd, *cwd.parents]:
        cli_root_file = parent / ".tf/cli-root"
        root_text = read_root_file(cli_root_file)
        if root_text:
            path = Path(root_text).expanduser()
            if path.exists():
                return path

    home_root_file = Path.home() / ".tf/cli-root"
    root_text = read_root_file(home_root_file)
    if root_text:
        path = Path(root_text).expanduser()
        if path.exists():
            return path

    here = Path(__file__).resolve()
    candidate = here.parent.parent
    if (candidate / "tf").is_dir() and (candidate / "pyproject.toml").is_file():
        return candidate

    return None


def find_uvx_source() -> Optional[str]:
    env_source = os.environ.get("TF_UVX_FROM", "").strip()
    if env_source:
        return env_source

    cwd = Path.cwd()
    for parent in [cwd, *cwd.parents]:
        source_file = parent / ".tf/cli-source"
        source = read_root_file(source_file)
        if source:
            return source

    home_source_file = Path.home() / ".tf/cli-source"
    source = read_root_file(home_source_file)
    if source:
        return source

    return None


def can_import_tf(python: str, env: Optional[Dict[str, str]] = None) -> bool:
    try:
        result = subprocess.run(
            [
                python,
                "-c",
                "import importlib.util, sys; sys.exit(0 if importlib.util.find_spec('tf.cli') else 1)",
            ],
            env=env,
            capture_output=True,
            text=True,
        )
        return result.returncode == 0
    except FileNotFoundError:
        return False


def exec_with_env(cmd: List[str], env: Optional[Dict[str, str]] = None) -> None:
    if env is None:
        env = os.environ.copy()
    os.execvpe(cmd[0], cmd, env)


def main() -> None:
    args = sys.argv[1:]
    uvx = shutil.which("uvx")
    python = shutil.which("python3") or shutil.which("python")

    repo_root = find_repo_root()

    if python and repo_root:
        env = os.environ.copy()
        existing = env.get("PYTHONPATH", "")
        env["PYTHONPATH"] = f"{repo_root}{os.pathsep}{existing}" if existing else str(repo_root)
        if can_import_tf(python, env):
            exec_with_env([python, "-m", "tf.cli", *args], env)

    if python and can_import_tf(python):
        exec_with_env([python, "-m", "tf.cli", *args])

    if uvx and repo_root:
        exec_with_env(["uvx", "--from", str(repo_root), "tf", *args])

    uvx_source = find_uvx_source()
    if uvx and uvx_source:
        exec_with_env(["uvx", "--from", uvx_source, "tf", *args])

    if uvx:
        exec_with_env(["uvx", "--from", DEFAULT_UVX_SOURCE, "tf", *args])

    print("ERROR: Unable to locate Ticketflow CLI runtime.", file=sys.stderr)
    print("Install uvx or Python with the tf package.", file=sys.stderr)
    raise SystemExit(1)


if __name__ == "__main__":
    main()
